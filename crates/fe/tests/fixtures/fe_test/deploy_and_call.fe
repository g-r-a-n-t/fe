/// Test deploying a high-level contract and calling methods on it.
/// Uses the high-level create2 and Call traits for contract interactions.

use std::evm::{Address, Evm, Call}
use std::evm::effects::assert
use core::abi::{Abi, AbiEncoder, AbiSize, Encode}
use std::abi::Sol

// Message types for the Counter contract
msg CounterMsg {
    #[selector = 0xd09de08a]
    Increment,
    #[selector = 0x6d4ce63c]
    Get -> u256,
}

// Manual AbiSize + Encode impls for msg variants (not yet auto-generated by desugaring)
impl AbiSize for CounterMsg::Increment {
    const ENCODED_SIZE: u256 = 0
}

impl Encode<Sol> for CounterMsg::Increment {
    fn encode<E: AbiEncoder<Sol>>(self, _ e: E) {
        // Empty struct, nothing to encode
    }
}

impl AbiSize for CounterMsg::Get {
    const ENCODED_SIZE: u256 = 0
}

impl Encode<Sol> for CounterMsg::Get {
    fn encode<E: AbiEncoder<Sol>>(self, _ e: E) {
        // Empty struct, nothing to encode
    }
}

// Storage struct for the counter
struct CounterStore {
    value: u256,
}

// High-level Counter contract using storage struct pattern
pub contract Counter {
    mut store: CounterStore

    init() uses (mut store) {
        store.value = 0
    }

    recv CounterMsg {
        Increment uses (mut store) {
            store.value = store.value + 1
        }

        Get -> u256 uses (store) {
            store.value
        }
    }
}

#[test]
fn test_deploy_and_call_counter() uses (mut evm: Evm) {
    // Deploy the counter contract using the high-level create2 API
    let contract_addr = evm.create2<Counter>(value: 0, args: (), salt: 0)

    // Verify deployment succeeded (address != 0)
    assert(contract_addr.inner != 0)

    // Call Get() using high-level Call trait - should return 0
    let initial_value: u256 = evm.call(
        addr: contract_addr,
        gas: 100000,
        value: 0,
        message: CounterMsg::Get {}
    )
    assert(initial_value == 0)

    // Call Increment() using high-level Call trait
    evm.call(
        addr: contract_addr,
        gas: 100000,
        value: 0,
        message: CounterMsg::Increment {}
    )

    // Call Get() again - should return 1
    let final_value: u256 = evm.call(
        addr: contract_addr,
        gas: 100000,
        value: 0,
        message: CounterMsg::Get {}
    )
    assert(final_value == 1)
}
