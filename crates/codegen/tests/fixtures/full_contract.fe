use std::evm::{Evm, RawMem, RawOps}

struct Point { x: u256, y: u256 }
struct Square { side: u256 }

impl Point {
    fn area(self) -> u256 {
        self.x * self.y
    }
}

impl Square {
    fn area(self) -> u256 {
        let side = self.side
        side * side
    }
}

fn abi_encode(value: u256) -> ! uses (mut ops: RawOps) {
    let ptr: u256 = 0
    ops.mstore(ptr, value)
    ops.return_data(ptr, 32)
}

#[contract_init(ShapeDispatcher)]
fn init() uses (mut evm: Evm) {
    let len = evm.code_region_len(dispatch)
    let offset = evm.code_region_offset(dispatch)
    evm.codecopy(dest: 0, offset, len)
    evm.return_data(0, len)
}

#[contract_runtime(ShapeDispatcher)]
fn dispatch() uses (mut evm: Evm) {
    let selector = evm.calldataload(0) >> 224
    if selector == 0x090251bf {
        let x = evm.calldataload(4)
        let y = evm.calldataload(36)
        let mut p = Point { x: x, y: y }
        p.x = p.x + 1
        p.y = p.y + 2
        let value = p.area()
        with (RawOps = evm) { abi_encode(value) }
    }
    if selector == 0x7b292909 {
        let side = evm.calldataload(4)
        let mut s = Square { side: side }
        s.side = s.side + 3
        let value = s.area()
        with (RawOps = evm) { abi_encode(value) }
    }

    evm.return_data(0, 0)
}
